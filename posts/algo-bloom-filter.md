## 概述

布隆过滤器是一种数据结构，比较巧妙的概率型数据结构（probabilistic data structure），特点是高效地插入和查询，可以用来告诉你 「某样东西一定不存在或者可能存在」，也就是判断一个元素是否存在一个集合中。

相比于传统的 List、Set、Map 等数据结构，它更高效、占用空间更少，但是缺点是其返回的结果是概率性的，而不是确切的，不适用于「零错误」的应用场合，但是适用于容忍低错误率的应用场合。难以删除数据也是其一大缺点，如果一定要实现，需要借助另外一个数组存储计数。

使用场景：

- 字处理软件中，需要检查一个英语单词是否拼写正确
- 在 FBI，一个嫌疑人的名字是否已经在嫌疑名单上
- 在网络爬虫里，一个网址是否被访问过
- yahoo, gmail 等邮箱垃圾邮件过滤功能

## 哈希函数

哈希函数是实现哈希表和布隆过滤器的基础。哈希函数的概念是：将任意大小的数据转换成特定大小的数据的函数，而转换后的数据称为哈希值或哈希编码。

![哈希函数](http://image.geekaholic.cn/20191202143411.png@0.8)

## 例子

布隆过滤器（Bloom Filter）的核心实现是一个**超大**的位数组和几个哈希函数。以下图为例：

![布隆过滤器例子](http://image.geekaholic.cn/20191202143503.png@0.8)

上面例子中集合里面有 3 个元素{x, y, z}，哈希函数的个数为 3（因为每个元素映射成 3 个比特位，每个映射的比特位对应一个哈希函数）。首先将位数组进行初始化，将里面每个位都设置位 0。对于集合里面的每一个元素，将元素依次通过 3 个哈希函数进行映射，每次映射都会产生一个哈希值，这个值对应位数组上面的一个点，然后将位数组对应的位置标记为 1。

查询 W 元素是否存在集合中的时候，同样的方法将 W 通过哈希映射到位数组上的 3 个点。如果 3 个点的其中有一个点不为 1，则可以判断该元素**一定不存在**集合中。反之，如果 3 个点都为 1，则该元素**可能存在**集合中，因为有可能是多个元素映射后共同作用下造成比特位都为 1 的。

## 布隆过滤器的取舍

显然，过小的布隆过滤器很快所有的 bit 位均为 1，那么查询任何值都会返回“可能存在”，起不到过滤的目的了。布隆过滤器的长度会直接影响误报率，布隆过滤器越长其误报率越小。另外，哈希函数的个数也需要权衡，个数越多则布隆过滤器 bit 位置位 1 的速度越快，且布隆过滤器的效率越低；但是如果太少的话，那误报率会变高。

如何选择业务的哈希函数个数（k）以及布隆过滤器的位数组长度（m）？

假设误报率为 p，插入元素个数为 n，省略推导过程，直接得出结果：

```js
m = -(n * Math.log(p)) / Math.pow(Math.LN2, 2);
k = (m / n) * Math.LN2;
```

用图片表示即为下图，来源见水印：

![图片表示](http://image.geekaholic.cn/20191202145855.png@0.8)

---

参考：

- [布隆过滤器 (Bloom Filter) 的原理和实现](https://www.jianshu.com/p/88c6ac4b38c8)
